package com.dgq.crs.dao;
import java.util.List;

import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.Select;
import org.apache.ibatis.annotations.Update;

import com.dgq.crs.entity.CrsDataCheckResult;
import com.dgq.crs.entity.ReportTaxInfo;

import tk.mybatis.mapper.common.Mapper;

/**
 * 税务报表信息持久层接口
 *
 * @author lishuaihao
 * @ create 2018-12-04 9:17
 */
public interface ReportTaxInfoDao extends Mapper<ReportTaxInfo> {
	
	@Select("select listagg(CORR_DOC_REF_ID, '~') within group(order by ACCOUNT_NUMBER) corrDocRefId, listagg(DOC_TYPE_INDIC, '~') within group(order by ACCOUNT_NUMBER) docTypeIndic, ACCOUNT_NUMBER accountNumber, listagg(CLOSED_ACCOUNT, '~') within group(order by ACCOUNT_NUMBER) closedAccount, listagg(DUE_DILIGENCE_IND, '~') within group(order by ACCOUNT_NUMBER) dueDiligenceInd, listagg(SELF_CERTIFICATION, '~') within group(order by ACCOUNT_NUMBER) selfCertification, listagg(ACCOUNT_BALANCE, '~') within group(order by ACCOUNT_NUMBER) accountBalance, listagg(ACCOUNT_BALANCE_CURR_CODE, '~') within group(order by ACCOUNT_NUMBER) accountBalanceCurrCode, listagg(ACCOUNT_HOLDER_TYPE, '~') within group(order by ACCOUNT_NUMBER) accountHolderType, max(OPENING_FINAME) openingFiname, listagg(PAYMENT_TYPE, '~') within group(order by ACCOUNT_NUMBER) paymentType, listagg(PAYMENT_AMNT, '~') within group(order by ACCOUNT_NUMBER) paymentAmnt, listagg(PAYMENT_AMNT_CURR_CODE, '~') within group(order by ACCOUNT_NUMBER) paymentAmntCurrCode, listagg(NAME_TYPE, '~') within group(order by ACCOUNT_NUMBER) nameType, listagg(LAST_NAME, '~') within group(order by ACCOUNT_NUMBER) lastName, listagg(MIDDLE_NAME, '~') within group(order by ACCOUNT_NUMBER) middleName, listagg(FIRST_NAME, '~') within group(order by ACCOUNT_NUMBER) firstName, listagg(NAME_CN, '~') within group(order by ACCOUNT_NUMBER) nameCn, listagg(PRECEDING_TITLE, '~') within group(order by ACCOUNT_NUMBER) precedingTitle, listagg(TITLE, '~') within group(order by ACCOUNT_NUMBER) title, listagg(NAME_PREFIX, '~') within group(order by ACCOUNT_NUMBER) namePrefix, listagg(GENERATION_IDENTIFIER, '~') within group(order by ACCOUNT_NUMBER) generationIdentifier, listagg(SUFFIX, '~') within group(order by ACCOUNT_NUMBER) suffix, listagg(GENERAL_SUFFIX, '~') within group(order by ACCOUNT_NUMBER) generalSuffix, listagg(ORGANISATION_NAME_EN, '~') within group(order by ACCOUNT_NUMBER) organisationNameEn, listagg(ORGANISATION_NAME_CN, '~') within group(order by ACCOUNT_NUMBER) organisationNameCn, listagg(GENDER, '~') within group(order by ACCOUNT_NUMBER) gender, listagg(LEGALADDRESS_TYPE, '~') within group(order by ACCOUNT_NUMBER) legaladdressType, listagg(COUNTRY_CODE, '~') within group(order by ACCOUNT_NUMBER) countryCode, listagg(ADDRESS_FREE_EN, '~') within group(order by ACCOUNT_NUMBER) addressFreeEn, listagg(CITY_EN, '~') within group(order by ACCOUNT_NUMBER) cityEn, listagg(STREET, '~') within group(order by ACCOUNT_NUMBER) street, listagg(BUILDING_IDENTIFIER, '~') within group(order by ACCOUNT_NUMBER) buildingIdentifier, listagg(SUITE_IDENTIFIER, '~') within group(order by ACCOUNT_NUMBER) suiteIdentifier, listagg(FLOOR_IDENTIFIER, '~') within group(order by ACCOUNT_NUMBER) floorIdentifier, listagg(DISTRICT_NAME, '~') within group(order by ACCOUNT_NUMBER) districtName, listagg(POB, '~') within group(order by ACCOUNT_NUMBER) pob, listagg(POST_CODE, '~') within group(order by ACCOUNT_NUMBER) postCode, listagg(COUNTRY_SUBENTITY, '~') within group(order by ACCOUNT_NUMBER) countrySubentity, listagg(ADDRESS_FREE_CN, '~') within group(order by ACCOUNT_NUMBER) addressFreeCn, listagg(PROVINCE, '~') within group(order by ACCOUNT_NUMBER) province, listagg(CITY_CN, '~') within group(order by ACCOUNT_NUMBER) cityCn, listagg(DISTRICT_NAME_CN, '~') within group(order by ACCOUNT_NUMBER) districtNameCn, listagg(POST_CODE_CN, '~') within group(order by ACCOUNT_NUMBER) postCodeCn, listagg(PHONE_NO, '~') within group(order by ACCOUNT_NUMBER) phoneNo, listagg(ID_TYPE, '~') within group(order by ACCOUNT_NUMBER) idType, listagg(ID_NUMBER, '~') within group(order by ACCOUNT_NUMBER) idNumber, listagg(RES_COUNTRY_CODE, '~') within group(order by ACCOUNT_NUMBER) resCountryCode, listagg(ISSUED_BY, '~') within group(order by ACCOUNT_NUMBER) issuedBy, listagg(IN_TYPE, '~') within group(order by ACCOUNT_NUMBER) inType, listagg(TIN, '~') within group(order by ACCOUNT_NUMBER) tin, listagg(EXPLANATION, '~') within group(order by ACCOUNT_NUMBER) explanation, listagg(NATIONALITY, '~') within group(order by ACCOUNT_NUMBER) nationality, listagg(to_char(BIRTH_DATE, 'yyyy-MM-dd'), '~') within group(order by ACCOUNT_NUMBER) birthDateStr, listagg(CITY, '~') within group(order by ACCOUNT_NUMBER) city, listagg(BIRTH_COUNTRY_CODE, '~') within group(order by ACCOUNT_NUMBER) birthCountryCode, listagg(FORMER_COUNTRY_NAME, '~') within group(order by ACCOUNT_NUMBER) formerCountryName, listagg(NAME_TYPE2, '~') within group(order by ACCOUNT_NUMBER) nameType2, listagg(LAST_NAME2, '~') within group(order by ACCOUNT_NUMBER) lastName2, listagg(MIDDLE_NAME2, '~') within group(order by ACCOUNT_NUMBER) middleName2, listagg(FIRST_NAME2, '~') within group(order by ACCOUNT_NUMBER) firstName2, listagg(NAME_CN2, '~') within group(order by ACCOUNT_NUMBER) nameCn2, listagg(PRECEDING_TITLE2, '~') within group(order by ACCOUNT_NUMBER) precedingTitle2, listagg(TITLE2, '~') within group(order by ACCOUNT_NUMBER) title2, listagg(NAME_PREFIX2, '~') within group(order by ACCOUNT_NUMBER) namePrefix2, listagg(GENERATION_IDENTIFIER2, '~') within group(order by ACCOUNT_NUMBER) generationIdentifier2, listagg(SUFFIX2, '~') within group(order by ACCOUNT_NUMBER) suffix2, listagg(GENERAL_SUFFIX2, '~') within group(order by ACCOUNT_NUMBER) generalSuffix2, listagg(CTRLG_PERSON_TYPE, '~') within group(order by ACCOUNT_NUMBER) ctrlgPersonType, listagg(NATIONALITY2, '~') within group(order by ACCOUNT_NUMBER) nationality2, listagg(LEGAL_ADDRESS_TYPE2, '~') within group(order by ACCOUNT_NUMBER) legalAddressType2, listagg(COUNTRY_CODE2, '~') within group(order by ACCOUNT_NUMBER) countryCode2, listagg(ADDRESS_FREE_EN2, '~') within group(order by ACCOUNT_NUMBER) addressFreeEn2, listagg(CITY_EN2, '~') within group(order by ACCOUNT_NUMBER) cityEn2, listagg(STREET2, '~') within group(order by ACCOUNT_NUMBER) street2, listagg(BUILDING_IDENTIFIER2, '~') within group(order by ACCOUNT_NUMBER) buildingIdentifier2, listagg(SUITE_IDENTIFIER2, '~') within group(order by ACCOUNT_NUMBER) suiteIdentifier2, listagg(FLOOR_IDENTIFIER2, '~') within group(order by ACCOUNT_NUMBER) floorIdentifier2, listagg(DISTRICT_NAME2, '~') within group(order by ACCOUNT_NUMBER) districtName2, listagg(POB2, '~') within group(order by ACCOUNT_NUMBER) pob2, listagg(POST_CODE2, '~') within group(order by ACCOUNT_NUMBER) postCode2, listagg(COUNTRY_SUBENTITY2, '~') within group(order by ACCOUNT_NUMBER) countrySubentity2, listagg(ADDRESS_FREE_CN2, '~') within group(order by ACCOUNT_NUMBER) addressFreeCn2, listagg(PROVINCE2, '~') within group(order by ACCOUNT_NUMBER) province2, listagg(CITY_CN2, '~') within group(order by ACCOUNT_NUMBER) cityCn2, listagg(DISTRICT_NAME2_CN, '~') within group(order by ACCOUNT_NUMBER) districtName2Cn, listagg(POST_CODE2_CN, '~') within group(order by ACCOUNT_NUMBER) postCode2Cn, listagg(RES_COUNTRY_CODE2, '~') within group(order by ACCOUNT_NUMBER) resCountryCode2, listagg(ISSUED_BY2, '~') within group(order by ACCOUNT_NUMBER) issuedBy2, listagg(IN_TYPE2, '~') within group(order by ACCOUNT_NUMBER) inType2, listagg(TIN2, '~') within group(order by ACCOUNT_NUMBER) tin2, listagg(EXPLANATION2, '~') within group(order by ACCOUNT_NUMBER) explanation2, listagg(to_char(BIRTH_DATE2, 'yyyy-MM-dd'), '~') within group(order by ACCOUNT_NUMBER) birthDate2Str, listagg(CITY2, '~') within group(order by ACCOUNT_NUMBER) city2, listagg(BIRTH_COUNTRY_CODE2, '~') within group(order by ACCOUNT_NUMBER) birthCountryCode2, listagg(FORMER_COUNTRY_NAME2, '~') within group(order by ACCOUNT_NUMBER) formerCountryName2, listagg(ORG_NAME_TYPE, '~') within group(order by ACCOUNT_NUMBER) orgNameType from reg.REPORT_TAX_INFO r left join REG.REPORT_FAIL_INFO f on r.doc_ref_id = f.doc_ref_id and r.reporting_period = f.data_year and r.message_ref_id = f.message_ref_id ${condition} group by ACCOUNT_NUMBER")
	public List<ReportTaxInfo> queryReportTaxInfoWithGroupByAccountNumber(@Param("condition")String condition);
	
	@Select("select r.*, case when r.doc_ref_id is not null then (case when f.doc_ref_id is not null then '报送失败' else '报送成功' end) else '未报送' end reportStatus, f.err_code errCode  from reg.REPORT_TAX_INFO r left join REG.REPORT_FAIL_INFO f on r.doc_ref_id = f.doc_ref_id and r.reporting_period = f.data_year  and r.message_ref_id = f.message_ref_id  ${condition}")
	public List<ReportTaxInfo> queryReportTaxInfoByCondition(@Param("condition")String condition);
	
	@Select("select listagg(NAME_TYPE2, '~') within group(order by ACCOUNT_NUMBER) nameType2, listagg(LAST_NAME2, '~') within group(order by ACCOUNT_NUMBER) lastName2, listagg(MIDDLE_NAME2, '~') within group(order by ACCOUNT_NUMBER) middleName2, listagg(FIRST_NAME2, '~') within group(order by ACCOUNT_NUMBER) firstName2, listagg(NAME_CN2, '~') within group(order by ACCOUNT_NUMBER) nameCn2, listagg(PRECEDING_TITLE2, '~') within group(order by ACCOUNT_NUMBER) precedingTitle2, listagg(TITLE2, '~') within group(order by ACCOUNT_NUMBER) title2, listagg(NAME_PREFIX2, '~') within group(order by ACCOUNT_NUMBER) namePrefix2, listagg(GENERATION_IDENTIFIER2, '~') within group(order by ACCOUNT_NUMBER) generationIdentifier2, listagg(SUFFIX2, '~') within group(order by ACCOUNT_NUMBER) suffix2, listagg(GENERAL_SUFFIX2, '~') within group(order by ACCOUNT_NUMBER) generalSuffix2, listagg(CTRLG_PERSON_TYPE, '~') within group(order by ACCOUNT_NUMBER) ctrlgPersonType, listagg(NATIONALITY2, '~') within group(order by ACCOUNT_NUMBER) nationality2, listagg(LEGAL_ADDRESS_TYPE2, '~') within group(order by ACCOUNT_NUMBER) legalAddressType2, listagg(COUNTRY_CODE2, '~') within group(order by ACCOUNT_NUMBER) countryCode2, listagg(ADDRESS_FREE_EN2, '~') within group(order by ACCOUNT_NUMBER) addressFreeEn2, listagg(CITY_EN2, '~') within group(order by ACCOUNT_NUMBER) cityEn2, listagg(STREET2, '~') within group(order by ACCOUNT_NUMBER) street2, listagg(BUILDING_IDENTIFIER2, '~') within group(order by ACCOUNT_NUMBER) buildingIdentifier2, listagg(SUITE_IDENTIFIER2, '~') within group(order by ACCOUNT_NUMBER) suiteIdentifier2, listagg(FLOOR_IDENTIFIER2, '~') within group(order by ACCOUNT_NUMBER) floorIdentifier2, listagg(DISTRICT_NAME2, '~') within group(order by ACCOUNT_NUMBER) districtName2, listagg(POB2, '~') within group(order by ACCOUNT_NUMBER) pob2, listagg(POST_CODE2, '~') within group(order by ACCOUNT_NUMBER) postCode2, listagg(COUNTRY_SUBENTITY2, '~') within group(order by ACCOUNT_NUMBER) countrySubentity2, listagg(ADDRESS_FREE_CN2, '~') within group(order by ACCOUNT_NUMBER) addressFreeCn2, listagg(PROVINCE2, '~') within group(order by ACCOUNT_NUMBER) province2, listagg(CITY_CN2, '~') within group(order by ACCOUNT_NUMBER) cityCn2, listagg(DISTRICT_NAME2_CN, '~') within group(order by ACCOUNT_NUMBER) districtName2Cn, listagg(POST_CODE2_CN, '~') within group(order by ACCOUNT_NUMBER) postCode2Cn, listagg(RES_COUNTRY_CODE2, '~') within group(order by ACCOUNT_NUMBER) resCountryCode2, listagg(ISSUED_BY2, '~') within group(order by ACCOUNT_NUMBER) issuedBy2, listagg(IN_TYPE2, '~') within group(order by ACCOUNT_NUMBER) inType2, listagg(TIN2, '~') within group(order by ACCOUNT_NUMBER) tin2, listagg(EXPLANATION2, '~') within group(order by ACCOUNT_NUMBER) explanation2, listagg(to_char(BIRTH_DATE2, 'yyyy-MM-dd'), '~') within group(order by ACCOUNT_NUMBER) birthDate2Str, listagg(CITY2, '~') within group(order by ACCOUNT_NUMBER) city2, listagg(BIRTH_COUNTRY_CODE2, '~') within group(order by ACCOUNT_NUMBER) birthCountryCode2, listagg(FORMER_COUNTRY_NAME2, '~') within group(order by ACCOUNT_NUMBER) formerCountryName2, listagg(ORG_NAME_TYPE, '~') within group(order by ACCOUNT_NUMBER) orgNameType from reg.REPORT_TAX_INFO where account_number = #{accountNumber} group by CTRLER_CODE")
	public List<ReportTaxInfo> queryControllingPersonByAccountNumber(@Param("accountNumber")String accountNumber);

	@Select("select * from reg.CRS_CHK_RESULT")
	public List<CrsDataCheckResult> queryCrsDataCheckResult();
	
	@Update("update reg.REPORT_TAX_INFO set doc_ref_id = #{docRefId}, message_ref_id = #{messageRefId} where account_number = #{accountNumber}")
	void fillDocRefIdAndMessageRefId(@Param("accountNumber")String accountNumber, @Param("docRefId")String docRefId, @Param("messageRefId")String messageRefId);
}